# Case-study оптимизации отображения
## Актуальная проблема

При большом объеме данных страница расписания показывается слишком медленно.

http://localhost:3000/%D0%B0%D0%B2%D1%82%D0%BE%D0%B1%D1%83%D1%81%D1%8B/%D0%A1%D0%B0%D0%BC%D0%B0%D1%80%D0%B0/%D0%9C%D0%BE%D1%81%D0%BA%D0%B2%D0%B0

Для уточнения задачи были загружены данные файла fixtures/large.json 
Сейчас на странице 1004 рейсов
Сейчас время отклика составляет 11_006 миллисекунд.

Бюджет не задан четко, но время загрузки должно быть "адекватно"

Идеальным временем зарузки страницы считаетсчя 50-100 миллисекунд. 

## Формирование метрики

Метрикой будет время ответа сервера, записаное в его логах. Сейчас это 11 секунд.

## Гарантия корректности работы оптимизированной программы

Так как работа по оптимизации не должна воздействовать на содержимое страницы был написан тест сверяющий страницу до внесенных измений с новой.

## Вникаем в детали системы, чтобы найти главные точки роста

Для того, чтобы найти "точки роста" для оптимизации я воспользовался
- gem 'rack-mini-profiler'
  
Вот какие проблемы удалось найти и решить

### Находка №0
- Страница загружается 11 секунд только первый раз, потом она загружается 4,5 секунд

### Находка №1
- rack-mini-profiler показал, что запросы для каждого trip делается дополнительный запрос по buses
- добавил eager_load для bus
- метрика именьшилась до 3,3 секунды
- Лишние запросы исчезли

### Находка №2
- rack-mini-profiler показал что запросы для каждого trip делается дополнительный запрос по services
- добавил eager_load для services
- метрика именьшилась до 2,4 секунды
- Лишние запросы исчезли. Осталось 4 sql запроса, из время выполнения 113 миллискунд

### Находка №3
- rack-mini-profiler показал что основное время занимает больше число вызово рендеринга trips/_services, который каждый раз рендерит trips/_service
- надо ускорить/упростить вызов
- метрика именьшилась до 1,1 секунды
- Лишние вызовы исчезли.

### Находка №4
- в процессе просмотр кода обнаружено, что для указания количества рейсов используется метод count, который делает дополнительный запрос
- загружать полностью выборку и использовать size
- метрика не изменилась
- Лишний запрос исчез.

### Находка №5
- rack-mini-profiler показал что основное время занимает рендеринг индекса
- просмотреть, что можно оптимизировать там.  
- решено собрать всё в один файл. Новый файл занимает 25 и остается читабельным
- метрика уменьшилась первоначально до 0,6 секунды при повторных вызовах до 0,2 секунды.

## Результаты
В результате проделанной оптимизации удалось получить страницу c 1000 рейсами менее чем за 0,6 секунды, что считааю достаточным показателем.

## Защита от регрессии производительности
Для защиты от потери достигнутого прогресса при дальнейших изменениях программы был написан тест с проверкой загрузки индексной страницы на 100 поездках (файле medium.json) менее чем за 0.3 секунд. Ограничение пришлось огрубить,так как загрузка большего объема сильно замедлит тестирование.

## Чем еще поделиться
1. Все ускорилось и без индекса по trips, хотя он очень просился. Эксперимент показал, что время контретно этого запроса уменьшается с 20 до 9 ms. Что для единичного запроса незначительно.

