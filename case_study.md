## Задача
Необходимо оптимизировать Rails приложение

Подготовительный этап:
- обновление версий гемов и Ruby, RoR
- проверка работоспособности приложения

### Оптимизация загрузки данных

Данные в БД должны обновляться из файла json. 
Данный файл может иметь до 100К записей маршрутов.

План действий: 
- провести замер первоначального состояния ( времени загрузки )
- написать 'красные' тесты
- оптимизировать до 'зеленого' теста

Инструменты:
- benchmark
- rspec
- activerecord-import
- rubocop

### Подготовительный
1) Написаны тесты для защиты от регрессии

#### Шаг 1.
1) Rubocop предупредил, что нужно добавить уникальные индексы для валидации `uniqueness`.  
Решение: добавить индексы для Buses#number, Cities#name

#### Шаг 2.
2) Использовал `Activerecord-Import ` чтобы оптимизировать загрузку.  
а) Сначала попробовал создать все инстансы и затем разом записать в базу.  
   На малом объеме сработало хорошо (~ 1 сек.), но на большом ушло около 140 сек.  
б) Решил заранее создать все Сервисы и хранить Города в памяти, чтобы не бегать за ними в базу каждый раз.  
   Помогло уменьшить кол-во запросов, но на время существенно не повлияло.  
в) Заметил, что автобусы не уникальны. Поэтому пришлось отказаться от параллельной загрузки вместе с Трипами и бегать за ними в базу.
Именно это и позволило уменьшить время до требуемого.  
г) Заменил парсер на Oj, что добавило пару секунд

Вывод: лучше лишний раз сбегать в базу, чем стараться все уместить в один большой INSERT!

| Размер | Было     | Стало   |
|--------|----------|---------|
| small  | 4,55 сек | 2,5 сек |
| medium | 13,2 сек | 8,9 сек |
| large  | 140  сек | 37 сек  |


### Оптимизация загрузки страницы
Инструменты:
- `rack-mini-profiler`
- `rails panel`
- `bullet`
- `explain`

#### Шаг 1.
Точка роста: Bullet предлагает добавить предзагрузку Bus и Services при загрузге трипов
Решение: добавить  `preload([bus: :services])`

Скорость загрузки страницы 

|       | Было    | Стало   |
|-------|---------|---------|
| Общая | 7103    | 3809    |
| Views | 6349    | 3785    |
| AR    | 748,6   | 21.9    |
| Alloс | 4745441 | 2951437 |

#### Шаг 2.
Точка роста: Рендеринг занимает бОльшую часть времени согласно `rails panel`
Решение: рендерить сервисы и разделитель прямо в базовом шаблоне. Понимаю, что использовать паршалы намного удобнее, но это прибавляет ~2 сек. на 1000 объектов

Скорость загрузки страницы

|       | Было    | Стало   |
|-------|---------|---------|
| Общая | 3809    | 1775    |
| Views | 3785    | 1750    |
| AR    | 21.9    | 21,6    |
| Alloс | 2951437 | 2988049 |

#### Шаг 3.
Точка роста: Рендеринг Трипа из паршила занимает бОльшую часть времени согласно `rails panel`
Решение: рендерить Трипы прямо в базовом шаблоне 

Скорость загрузки страницы

|       | Было    | Стало   |
|-------|---------|---------|
| Общая | 1775    | 1163    |
| Views | 1750    | 1137    |
| AR    | 21,6    | 21,5    |
| Alloс | 2988049 | 2373378 |

#### Шаг 4.
Точка роста: Отчет pg_hero показал в Топе запрос   
`SELECT COUNT(*) FROM "trips" WHERE "trips"."from_id" = '2' AND "trips"."to_id" = '2'`  
Через экплейн видно, что отсутсвует индекс в `buses_services`  
`Seq Scan on trips  (cost=0.00..2334.00 rows=1 width=0)
Filter: ((from_id = 2) AND (to_id = 2))`

Решение: добавить индекс from_id + to_id

Скорость загрузки страницы

|       | Было    | Стало   |
|-------|---------|---------|
| Общая | 1163    | 1162    |
| Views | 1137    | 1150    |
| AR    | 21.6    | 19.6    |
| Alloс | 2373378 | 2368590 |


#### Шаг 5.
Точка роста: Отчет pg_hero показал в Топе запрос   
`SELECT "buses_services".* FROM "buses_services" WHERE "buses_services"."bus_id" IN ('222','333')`  
Через экплейн видно, что отсутсвует индекс в `buses_services`  
`Seq Scan on buses_services  (cost=0.00..81.68 rows=9 width=16)
Filter: (bus_id = ANY ('{222,333}'::integer[]))`

Решение: добавить индекс

Скорость загрузки страницы

|       | Было    | Стало   |
|-------|---------|---------|
| Общая | 1163    | 1108    |
| Views | 1137    | 1097    |
| AR    | 19.6    | 7.7     |
| Alloс | 2373378 | 2372198 |


Конечными точками Топ-10 запросах из отчет pg_hero стали поиск по индексам и служебные запросы.  
По итогам работы страница рендерится за ~1.1 секунду.
