# Case-study оптимизации

## Актуальная проблема
В нашем проекте возникла необходимость обработки файла с большим объемом данных и записи этих данных в БД.

В текущей реализации процесс занимает непозволительно долгое время:
small.json - около 10 сек.
medium.json - около 70 сек.
large.json - около 750 сек.

## Первые шаги
Для начала было решено обновить версии ruby и rails до актуальных (3.1.2 и 7.0.3 соответственно)

Ощутимого результата это не дало, прирост производительности составил около 5%

## Оптимизация импорта данных
Для защиты от регресса использовался `Benchmark.realtime`, который показывал время выполнения импорта данных.

Анализ сервиса импорта данных показал, что он вызывает слишком много запросов в базу на каждой итерации.

Было решено использовать достыпные в новой версии `rails` методы `upsert_all` и `insert_all`

Несмотря на то, что в данных методах есть защита от дубликатов, чтобы не загружать в память повторяющиеся записи, на этапе формирования данных повторы отсекались с помощью метода `.uniq`

Вместо загрузки записей из БД для формирования связей, использовались `id` записей

Все эти изменения позволили значительно сократить время импорта данных, которое теперь составляет около 12.5 секунд на полном объеме (large.json)

## Оптимизация отображения данных на странице
После импорта файлов был произведен анализ с помощью `PgHero`
Как и ожидалось, в таблицы необходимо было добавить индексы. После их добавления `PgHero` полностью позеленел.

Для анализа рендеринга попробовал использовать расширение для браузера `RailsPanel`, к тому же оно уже было установлено и я периодически им пользовался.
К сожалению в версии `Rails 7` расширение не работает. После отката на `Rails 6` плагин запустился один раз, затем через какое-то время завис и больше его панель даже не появлялась в инспекторе. Переустановка так же не помогла.

Возвращаем `Rails 7`

При первом запуске `RailsPanel` показал огромное количество рендеринга паршиалов для каждой записи. Это и предстоит оптимизировать.

После уменьшения количества паршиалов с помощью рендера коллекции и передачи разделителя как параметра `spacer_template` рендеринг страницы с автобусами `Самара - Москва` стал занимать чуть более 1 секунды.

## RSpec

Для проверки правильности импорта данных был добавлен небольшой тест.
