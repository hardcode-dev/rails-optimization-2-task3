# Case-study

## Актуальная проблема

На проекте используется механизм импорта данных из JSON-файла.
При больших объемах данных такой импорт выполнялся слишком долго, 
в связи с чем возникла необходимость такой импорт оптимизировать.
Кроме того, при загрузке страницы с расписанием при больших данных сервер отдавал
ответ слишком долго. В связи с этим возникла необходимость ускорить импорт данных и
загрузку страницы.

## Формирование метрики
Для того, чтобы понимать, дают ли мои изменения положительный эффект на быстродействие программы я решил использовать такую метрику: время обработки файла с 10000 записей

## Гарантия корректности работы оптимизированной программы
Для гарантии корректности работы программы я реализовал 2 теста: тест корректности
импорта и тест корректности вывода данных на странице расписания. Это позволит
не допустить поломки программы при ее оптимизации.

## Feedback-Loop
Для того, чтобы иметь возможность быстро проверять гипотезы я выстроил эффективный `feedback-loop`, который позволил мне получать обратную связь по эффективности сделанных изменений за несколько секунд

Вот как я построил `feedback_loop`:
1. измеряю время работы импорта
2. с помощью отчетов pghero определяю главную точку роста
3. изменяю код
4. запускаю тесты

## Процесс оптимизации импорта

### 1. Большое количество запросов к таблицам автобусов и услуг
Добавил индексы для полей number и model автобусов, а также добавил индексы для
поля name услуг. Кроме того, добавил индексы на внешние ключи связующей таблицы buses_services.
В результате время импорта 10000 записей сократилось с 147 секунд до 120 секунд.


### 2. Большое количество запросов к таблице услуг автобусов
Добавил механизм кэширования, сохраняя bus_id и service_id каждой услуги в массив хэшей.
Время импорта сократилось с 120 секунд до 78.

### 3. Большое количество запросов получения значения name таблицы cities
Добавил механизм кэширования для таблицы cities. Время импорта сократилось с 78
секунд до 45.

### 4. Большое количество запросов к таблице buses
Добавил механизм кэширования для таблицы buses. Время импорта сократилось с 45
секунд до 30.

### 5. Большое количество запросов на создание экземпляров BusesService
Реализовал создание сразу нескольких экземпляров с помощью гема Activerecord-Import.
Время импорта сократилось с 30 сек до 9. Импорт файла large.json стал занимать 
примерно 62 секунды.


## Процесс оптимизации отображения расписаний

### 1. Большое количество времени занимал запрос автобусов поездки и рендер партиалов
Вынес основные запрашиваемые поля поездки в хэш, чтобы избежать дублирования запросов
к БД. Также удалил лишние партиалы. Среднее время рендера страницы снизилось с 2.1 сек
до 1.3.

### 2. N+1 проблема при загрузке автобусов для поездки
С помощью гема Bullet нашел проблему N+1 запроса и решил ее с помощью нетерпеливой
загрузки автобусов и услуг автобусов для поездки: Trip.includes([:bus => :services])
Среднее время рендера страницы снизилось с 1.3 секунд до 900 мс.

### 3. Долгий рендеринг вьюх
Вынес весь рендер из партиалов в один файл. Рендеринг стал занимать примерно 5 мс.
Среднее время загрузки снизилось до 300 мс. Страница для данных из файла large.json
стала грузиться 1.8 секунд, из них ActiveRecord и рендеринг занимают всего около 100 мс.

