# Case-study оптимизации

## Актуальная проблема
В нашем проекте возникла серьёзная проблема.

Наше приложенене неплохо себя показало на тестовых данных, однако оказалось, что в реальной жизни нам потребуется
загружать и отображать значительно большее количество рейсов, чем мы первоначально планировали.

От бизнеса был получен файл large.json объемом 32MB, выявивший две проблемы: 

1) Слишком медленная загрузка данных в базу
2) Слишком долгое отображение страниц веб-приложением

Попробуем решить обе проблемы. 

## Гарантия корректности работы оптимизированной программы
Напишем тест, проверяющий корректную загрузку и отображение рейсов из файла example.json. Для этого перенесем
логику обработки файла из рейк-таски в отдельный класс и напишем тест, проверяющий корректное отображение страницы
рейсов Самара - Москва

## Первая проблема - Слишком медленная загрузка данных в базу

### Метрика
Я решил использовать две метрики -  непосредственно скорость обработки файла и потребление памяти.
В проекте удобно предоставляются файлы разного размера, что позволит переходить от меньшего файла к большему по мере
оптимизации. 

### Feedback-Loop
Для того, чтобы иметь возможность быстро проверять гипотезы я выстроил `feedback-loop`,
который позволил мне получать обратную связь по эффективности сделанных изменений за 5-10 секунд

`feedback-loop` представляет из себя запуск rake таски импорта файла

- bin/rake reload_json[fixtures/small.json]

в вывод которой я добавил отчет о затраченном времени и потреблении памяти

## Динамика потребления памяти
Прежде всего выясним динамику потребления памяти при импорте данных из файла. Для этого
используем valgrind massif visualier
![valgrind massif visualier](./img/2019-09-08.png)
На графике виден стабильный крутой рост потребления памяти на всем протяжении времени работы скрипта.

Попробуем провести рефакторинг таким образом, чтобы не накапливать данные в памяти.

Так же в отчете ruby_prof qcachegrind видно, что значительно время занимают find_by / 
find_or_create_by методы. Попробуем от них избавиться. 

Значения метрик для файла small.json - 12 секунд, 71 mb

После рефакторинга импорт файла small.json стал занимать 0.91 секунды. Это позволило
имторировать файл large.json за 26 секунд (используя 347 мб рам), что соответствует бюджету.

Коммитим изменения