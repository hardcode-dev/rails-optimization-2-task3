# Case-study оптимизации

## Формирование метрики
Для того, чтобы понимать, дают ли мои изменения положительный эффект на быстродействие программы я придумал использовать такую метрику:
Для начала я решил пропарсить файл small.json
Я обернул rake таску в Benchmark.measure - в итоге, время обработки(парсинг) файла small.json составило 10 секунды

Вот как я построил `feedback_loop`:

- Профилирование
- Обнаружение точки роста(PGHERO)
- Оптимизация
- Запуск тестов, чтобы убедиться, что программа возвращает нужный результат(работает верно)
- Метрика (использование Benchmark.measure, чтобы определить время выполнения)

Для защиты от регресии написал тест проверяющий количество сохраненных записей в базе по каждой таблице

### Ваша находка №1
Воспользовался PGHERO и он мне выдал следующую картину (после запуска скрипта импорта medium.json)
![pghero_mediun first](https://i.imgur.com/dJrZE3q.png)
я последовал рекомендации PGHERO и добавил индекс для поля number в таблице buses
скорость импорта сократилась с 10 до 9.6 секунд

### Ваша находка №2
я убрал лишние промежуточные переменные и стал записывать объект сразу в массив
скорость импорта сократилась с 9.6 до 8.7 секунд

### Ваша находка №3
Я заменил find_or_create_by на find_or_initialize_by для Bus
скорость импорта сократилась с 8.7 до 7.9 секунд


### Ваша находка №4
PGHERO показал что скрипт дергает промежуточную таблицу
я создал модель для промежуточной таблицы и стал записывать данные прямо туда, минуя ассоциацию
скорость импорта сократилась с 7.9 до 6 секунд

### Ваша находка №5
PGHERO показал что таблица bus вызывается дважды
я объеденил создание объекта и его обновление 
скорость импорта сократилась с 6 до 4.6 секунд

### Ваша находка №6
Убрал лишний вызов find_or_create_by для Bus
скорость импорта сократилась с 4.6 до 4.4 секунд

### Ваша находка №7
Убрал лишние вызов find_or_create_by для Service
скорость импорта сократилась с 4.4 до 3.1 секунд

### Ваша находка №8
Сменил файл на fixtures/medium
Добавил Записи для Trip в import
скорость импорта сократилась с 21 до 14 секунд

### Ваша находка №9
Добавил Записи для City в import
скорость импорта сократилась с 14 до 6.6 секунд

### Ваша находка №10
Сменил файл на fixtures/large
скорость импорта сократилась с ~∞ до 36 секунд

### Ускорение загрузки страницы

### Ваша находка №1
С помощью гема bullet я увидел что имеется проблема n+1
убрал проблему, скорость загрузки заметно улучшилась 

### Ваша находка №1
Сделал пару мини фиксов во вьюхах
скорость загрузки немного улучшилась

### Ваша находка №2
Добавил все необходимые индексы
Скорость вызросла в разы

### Ваша находка №3
гем rack-mini-profiler показал что фрагменты во вьюхах грузятся огромными количествами
я добавил кэширование для таких фрагментов, скорость загрузки страниц сократилась значительно

### Дополнения:
Дополнительно убедился что при каждом импорте данных кэш сбрасывается, это идеальный вариант для приложения
Переносить все фрагменты в одну вьюху не стал так как кэширование решило проблему загрузки страницы, теперь страница грузится за ~ 200ms

Написал тест для проверки генерируемого html 
