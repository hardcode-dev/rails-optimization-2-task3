# Case-study оптимизации

## Актуальная проблема
Оптимизация rails приложения

1. Медленная загрузка изначальных данных
2. Не оптимальная работа приложения по выводу информации

## Формирование метрики
Для первой части задания метрикой является время загрузка в БД изначальных данных
Бюджет метрики - large файл с данными должен загружаться быстрее минуты

Для второй части необходимо провести оптимизацию вывод информации

## Feedback-Loop
Вот как я построил `feedback_loop` для проверки загрузки данных:
т.к. идея на данном этапе понятна - это использовать activerecord-import и делать как можно меньше запросов, то:
- проверить время загрузки
- внести изменения в алгоритм
- повторить

## Находка 1
Раздумия над алгоритмом загрузки показали, что:
- должно быть слишком много запросов на создание/поиск городов, т.к. их всего 10, то проще и быстрее создать их за 1 прозод через файл, сформировать список загруженных и затем использовать его вместо постоянного обращения к БД
- с сервисами такая же проблема, к тому же в описании задания сказано, что их всегда 10, можно заранее загрузить
- для загрузки автобусов и маршрутов использовать activerecord-import с подставлением заранее загруженных данных по городам и сервисам
- в БД нет индексов, поэтому загрузка данных будет максимально быстрой
- добавил валидацию на уникальность для сервисов по названию (особо не имеет смысла, если сервисов всегда 10 и они не меняются, но пусть будет)

### Решение 1
- гипотеза: использовать activerecord-import,
- применение: сперва переделал алгоритм загрузка с использованием гема, в итоге время загрузка small файла уменьшилось, но даже medium файл загружается больше минуты

### Решение 2
- гипотеза: проходить через json несколько раз, с загрузкой части данных
- применение:
  - во время первого прохода через json формируются массивы для городов и сервисов, затем список городов формируется в хэш, { название => айди }, для загрузки путешествий нужен будет только айди города, сервисы - { название => объект }, т.к. для создания записей через has_and_belongs_to_many для автобусов нужно будет передавать массив объектов
  - во время второго прохода формируется список автобусов, для сервисов используются заранее загруженные данные
  - для городов и автобусов - данные формируются через результат работы гема, без доп запросов в БД
  - при третьем проходе формируются маршруты
- результат
  - medium файл стал загружаться за 7 секнуд
  - large - 23 секунды

### Решение 3
- вспомнил, что сервисы постоянны
- применение:
  - сервисы создаются заранее, без прозода по массиву данных
  - на первом проходе через данные теперь формируется список городов и автобусов
  - на втором проходе - формируются маршруты
результат
  - время обработки визуально не изменилось, но должно быть чуточку быстрее, особенно на гигантских данных
  - последние данные по времени загрузки - 22 секунды
