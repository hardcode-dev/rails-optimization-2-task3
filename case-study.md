# Case-study оптимизации

## Актуальная проблема
1. Оптимизировать время обработки файла `large.json`
2. Оптимизировать время для отображения необходимых рейсов.

## Формирование метрики

- small.json (1K трипов)
- medium.json (10K трипов)
- large.json (100K трипов)

Время полной обработки `large.json` должно составлять не более 60сек.

## Гарантия корректности работы оптимизированной программы
1. Для импорта данных был написан тест, который гарантирует, что код до и после оптимизации создает одинаковое кол-во данных.
2. Для отображения данных на странице так же был написан тест, который проверяет, что кол-во элементов до и после оптимизации одинаковое для тестового файла.

## Feedback-Loop
### Для импорты данных
Прежде чем приступить к оптимизации – я написал тест, проверяющий корректность данных после запуска импорта.

1. Определение точки роста.
2. Рефакторинг.
3. Тест.

### Для отображения данных на странице.
Прежде чем приступить к оптимизации – я написал тест, проверяющий корректность данных на странице рейсов.

1. Определение точки роста.
2. Рефакторинг.
3. Тест.

## Вникаем в детали системы, чтобы найти главные точки роста
Для того, чтобы найти "точки роста" для оптимизации я воспользовался
- rspec-benchmark
- ruby-prof

## Вот какие проблемы удалось найти и решить
### Импорт данных
Основная проблема была из-за построчной обработки данных, что было мною сделано:

1. Bulk insert все сервисов, что позволяет сразу же ссылаться на нужные для всех автобусов.
2. Стриминговая вставка всех рейсов.
3. Bulk insert городов и автобусов.
4. Стриминговая вставка сервисов для автобусов.

Суммарно мне удалось ускорить импорт в ~36 раз, проверяя на файле `small.json`. Было ~25 секунд, стало ~0.7 секунд.

### Отображение данных.
В ходе профилирования мною было выявлено 2 основных проблемы:

1. N + 1.
2. Затраты на partial render.

Что было сделано:
1. Устранены все N + 1, путем includes.
2. Убрал partials render, делая это прямо во view.
3. Добавил кэширование страницы в зависимости от параметров на 1 минуту (время было выбрано случайно, оно очень сильно зависит от бизнеса и задачи).

## Результаты
### Импорт
Удалось ускорить время выполнения в ~36 раз (с 25 секунд до 0.7), был написано тест, проверяющий корректность выполнения и проверяющий, что программа работает быстрее, чем 1 секунду.

### Отображение данных на странице
Удалось ускорить время ответа страницы в ~19 раз (с 16 секунд до ~0.8 без кэширования, с кэширование 28ms). Был написан тест, проверяющий корректность данных на странице.
