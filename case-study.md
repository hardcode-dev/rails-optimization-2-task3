# Case-study оптимизации

## Актуальная проблема
В нашем проекте возникли следующие проблемы:
* Долгий импорт данных в БД
* Долгий рендеринг страницы расписаний

## Формирование метрики
Для того, чтобы понимать, дают ли мои изменения положительный эффект на быстродействие программы я придумал использовать такую метрику:
* время загрузки данных из файла с 1К трипов.
* Loading data from fixtures/small.json - 8.588481 сек
* Бюджет загрузки файла со 100К трипов - 60 сек

## Гарантия корректности работы оптимизированной программы
Тест корректности загрузки данных `spec/services/json_loader_spec.rb`. Выполнение этого теста в фидбек-лупе позволяет не допустить изменения логики программы при оптимизации.

## Feedback-Loop
Для того, чтобы иметь возможность быстро проверять гипотезы я выстроил эффективный `feedback-loop`, который позволил мне получать обратную связь по эффективности сделанных изменений за *время, которое у вас получилось*

Вот как я построил `feedback_loop`:
- анализ отчетов
- изменения в программе
- замер метрики
- запуск теста

## Вникаем в детали системы, чтобы найти главные точки роста
Для того, чтобы найти "точки роста" для оптимизации я воспользовался:
- rack-mini-profiler
- rails panel
- bullet
- explain запросов

Вот какие проблемы удалось найти и решить

### Итерация №1
- Загрузка данных с помощью activerecord-import gem
    * Loading data from fixtures/small.json - 8.588481 сек -> 1.624000 сек
    * Loading data from fixtures/large.json - 57.876000 сек (в рамках бюджета). MEMORY USAGE: 13 MB

### Итерация №2
- Рендеринг страницы - 23327ms (Views: 21580.9ms | ActiveRecord: 1678.5ms)
- Bullet Warnings
  * USE eager loading detected Trip => [:bus] Add to your query: .includes([:bus])
- Добавил preload(bus: :services). Заменил has_and_belongs_to_many на has_many through.
  - Рендеринг страницы - 11866ms (Views: 11796.6ms | ActiveRecord: 61.9ms)
  - Bullet Warnings отсутствуют.

### Итерация №3
- rack-mini-profiler и rails panel указывают на рендеринг большого кол-ва паршалов.
- убрал лишние паршалы.
- Рендеринг страницы - 2773ms (Views: 2706.0ms | ActiveRecord: 55.2ms)

### Итерация №4
- В rails panel (ActiveRecord) увидел лишний запрос к таблице trips.
- изменил расчет кол-ва трипов.
- Рендеринг страницы - 2789ms (Views: 2748.7ms | ActiveRecord: 34.7ms)
- Number of executed queries -= 1

### Итерация №5
- PGHERO предложил создать индексы:
```
CREATE INDEX CONCURRENTLY ON trips (from_id, to_id)
CREATE INDEX CONCURRENTLY ON buses_services (bus_id)
```
- Рендеринг страницы - 2810ms (Views: 2788.8ms | ActiveRecord: 15.5ms)


## Защита от регрессии производительности
Для защиты от потери достигнутого прогресса при дальнейших изменениях программы `spec/services/json_loader_spec.rb`
