# Case-study оптимизации

## Актуальные проблемы и цели

### А Импорт данных в БД из JSON файла

**Проблема**: Импорт данных из json файла занимает огромное количество памяти и процесс падает по памяти

**Цель 1**: оптимизировать загрузку по времени (100_000 маршрутов грузятся меньше 1 минуты)

**Цель 2 (бонус)**: успешная загрузка файла в 10 миллионов маршрутов

### Б Долгое отображения расписаний (например, страница автобусы/Самара/Москва)

**Проблема**: Страница грузится несколько десятков секунд

**Цель**: загрузка 1000 маршрутов на странице автобусы/Самара/Москва (сиды large.json) меньше 1 сек

## Решение проблемы А

### Подготовительные моменты

1) Вынесли импорт в отдельный сервис ReloadJsonService
2) Написали тест для проверки корректности загрузки example.json

### Feedback-Loop

1) Измерение времени загрузки эталонного файла json, анализ слабых мест
2) Внесение оптимизации в скрипт загрузки
3) Проверка корректности загрузки тестом
4) Измерение времени улучшенной версии скрипта

### Подход №1

Ничего непонятно после профилирования скрипта с помощью memory_profiler.
Все точки роста указывают на библиотеку ActiveRecord. Поэтому приходится улучшать файл интуитивно.

### Подход №2

В консоли видим огромное количество sql запросов в БД,
с помощью гема activerecord-import добиваемся уменьшения количества транзакций и отмены валидаций.
Импортируем маршруты по 1000 штук.

Добиваемся выполнения 1-й цели: файл large.json грузится около 30 сек.

### Подход №3

Реализуем скрипт в потоковом виде в сервисе ReloadJsonServiceProfile
Добавиваемся 2-й цели - успешно импортируем 10 миллионов маршрутов за 25 минут
Также улучшается загрузка эталонного large.json c 30 сек до 12 сек
Добавляем прогрессбар чтобы было веселее ждать.

Используем потоковый скрипт в bin/setup как самый эффективный.

### Защита тестами итогового варианта

1) Пишем тест на корректность для сервиса ReloadJsonServiceProfile
2) Пишем тест, что сиды small.json грузятся меньше 0.4 сек

## Решение проблемы Б

## Подготовительные моменты

Устанавливаем гемы rack-mini-profiler, bullet, strong_migrations, rails panel

### Feedback-Loop

1) C помощью инструментов для разработчика браузера и Rails panel смотрим время загрузки страницы
2) Анализ точек роста с помощью инструментов и интуиции
3) Улучшение
4) Измерение времени улучшенной версии

### Подход №1

Rails panel показывает что на наборе large.json 20,5 сек занимает рендеринг страницы
и 1,5 сек запросы к ActiveRecord

Таким образом, главная точка роста сейчас - рендеринг.
Самого лучшего результата добился избавившись от частичных шаблонов.
Рендеринг страницы с сидами из large.json стал занимать 3 сек.
Что тоже много, но пока не понятно что можно сделать с этим.

### Подход №2
Переходим к оптимизации запросов к БД.
- Убрали n+1 запрос с помощью bullet и стало медленнее
- Теперь добавим индексы
В логах и rack-mini-profiler видно что нужен индекс на id в таблице buses (700мс запрос)
и составной индекс [from_id, to_id] для таблицы trips (1,3 сек запрос)
также можно добавить индекс на поиск по имени города (100мс)

В итоге с БД разобрались, все запросы к БД выполняются суммарно около 40мс, пробуем вернуться к рендерингу,
сейчас он занимает около 2,5 сек.

### Подход №3

Долго думал, что не так с рендерингом.
В итоге отключил все гемы для отладки - получилось 300-600 мс на сидах large.json
Таким образом, добились цели

