# Case-study оптимизации

## Актуальные проблемы

1. Необходимо импортировать в БД данные, предоставляемые в формате `json`.
Имеющаяся версия 'импортера' написана неоптимально и не позволяет за приемлемое время обрабатывать большие объемы данных (более 10_000 записей)
2. Страница со списком всех вариантов поездок из города А в город Б загружается крайне медленно даже для небольшого числа возможных поездок.
Я решил исправить эту проблему, оптимизировав программу.

## Формирование метрики

Для того, чтобы понимать, дают ли мои изменения положительный эффект на быстродействие программы я придумал использовать такие метрики:
1. Импортирование даннах из файла `json` со 100_000 в БД должно занимать менее, чем 60 секунд.
2. Загрузка страницы `Trip#index` для данных из файла `example.json` должна быть менее 100 мс.

## Гарантия корректности работы оптимизированной программы

Программа поставлялась без теста. Для проверки корректности загружаемых в БД данных был написан тест `exampe_spec.rb`.

## Feedback-Loop

Для того, чтобы иметь возможность быстро проверять гипотезы я выстроил эффективный `feedback-loop`, который позволил мне получать обратную связь по эффективности сделанных изменений за 2-3 минуты. Вот как я его построил:

#### Для первой части задания:
- Запускать очищение БД и импорт даннах
- Анализировать запросы к БД с помошью `PG Hero`
- Оптимизировать код.
- Проверять скорость и корректность выгрузки данных в БД

#### Для второй части задания:
- Загружать страницу `Trip#index` и проверять время загрузки
- Анализировать сообщения от `Bullet` и `rack-mini-profiler`
- Оптимизировать предложенные `Bullet` запросы и код в видах и паршалах, которые рендерятся дольше всего

## Вникаем в детали системы, чтобы найти главные точки роста
Для того, чтобы найти "точки роста" для оптимизации я воспользовался
`PG Hero`, `Bullet`, `rack-mini-profiler` и чтение логов

## Вот какие проблемы удалось найти и решить

#### Находка №1-1
- `PG Hero` подсказал, что в БД не хватает индексов для таблиц City и Bus
- Решение: добавление индексов
- Результат: незначительный прирост скорости на файлах малого объема

#### Находка №1-2
- `PG Hero` показал, что во время импорта происходит гигантское число индивидуальных запросов на добавление в БД
- Решение: группировка вновь инициализированных экземпляров моделей в массив и их групповой импорт БД при помощи гема
`activerecord-import`
- Результат: Попадание ниже установленного максимума на время обработки 100_000 записей.

#### Находка №2-1
- `Bullet` указал на N+1 запрос в методе `Trip#index`
- добавление `includes(bus: :services)` принесло увеличение скорости загрузки в 2 раза (около 200 мс)

#### Находка №2-2
- `rack-mini-profiler` указал на дополнительный запрос к БД от метода `count`
- `count` был заменен на `size` и принес небольшое увеличение скорости загрузки (около 180 мс)

#### Находка №2-3
- вычисления из вида были пененесены в соответствующую модель. Это не дало прироста или потери скорости, но позволило сделать файл более чистым.

#### Находка №2-4
- попытка загрузить все данные поездок в хеш и обращаться к нему из вида обернулась потерей в производительности,
страница стала загружаться в 3 раза медленнее.

#### Находка №2-5
- Был добавлен составной индекс для маршрутов, чтобы ускорить загрузку данных при поиске по двум городам

#### Находка №2-6
- с помошью логов сервера было обнаружено, что очень много времени уходит на рендеринг паршалов
- избавление от них и перенос всего кода в один файл `index.html.erb` дало общую скорость загрузки страницы около 70 мс.


## Результаты
* загрузка данных в БД из файла cо 100_000 записями снизилось до 21 секунды
* время загрузки страницы для импортированного `example.json` стало составлять около 70 мс.
