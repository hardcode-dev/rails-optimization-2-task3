# Case-study оптимизации

## 1 - Загрузка JSON в базу данных шаг 1
  Начал я с того что установил rspec и написал тесты для контроллера и рейк таски. Тест для рэйк таски все время проходил при любом времени обработки, наверное из за асинхронности рейка. Пришлось убрать ее в app и создать для нее класс там. С загрузкой json особо не мудрствовал, просто добавляя повторяющиеся объекты в массив получилось обработать большой файл за 2 минуты. Задействовал activerecord-import и сократив время обработки до 30 секунд и остановился на этом. В реальной жизни я бы на двух минутах остановился, ещё может быть и sleep воткнул между итерациями, чтобы на полчаса-час это растянуть. 

## 2 - Оптимизация TripsController#index шаг 1
  Итак, начинаме мы со следующего: консоль рельс: (Views: 9547.9ms | ActiveRecord: 1741.6ms) rack-mini-profiler показал что patrials тоже делают запросы. добавил preload (Views: 4093.9ms | ActiveRecord: 64.5ms). Потом я обратил внимание что ни в одном автобусе нет ни одного сервиса и посчитал эьто странным. Обнаружил что я Автобусы импортировал пачкой, а джойнеры нет, а в тесте я проверял только сами сервисы на наличие. Переделал DatabaseSeeder, прогнал тесты, убедился что все работает. Итак, результаты с Джойнерами на большом файле: до preload (Views: 25969.6ms | ActiveRecord: 2323.2ms), после (Views: 19946.3ms | ActiveRecord: 94.8ms). Запросов соответственно 7. Дальше я решил загрузить большие файлы, чтобы посмотреть насколько дальше можно сопримизировать БД

## 3 - Загрузка JSON в базу данных шаг 2
  Как делать загрузку в потоковом режиме вы описали в readme, я оттуда ее и скопировал. Удивило то что внутри блока нельзя делать никаких запросов к базе вообще. Даже City.new выдавал ошибку, наверное спрашивал про дефолтные значения. После небольшого тюнинга в потоковом режиме время обработки fixtures/large.json сократилось до 15 секунд. На файле в 10 миллионов все зависало поэтому пришлось оптимизировать структуру данных для справочников Bus и Сity я хранил их в хешах, что ускорило время обработки когда файл стал большим. Для автобусов хотел сделать хэш двухуровневым, но .values.map(&:values).flatten занимал больше времени чем экономил хэш. Также джойнеры BusesService записывал в файл временно, потому что памяти на файле в 10 миллионов они занимали довольно много. 

## 4 - Оптимизация TripsController#index шаг 2
  Итак, с чего мы начали: (Views: 7163.0ms | ActiveRecord: 9599.3ms)
  1. Meняем @trips.count на @trips.length один запрос ушел, странно что я этого не заметил раньше
  2. add_index :cities, :name
  3. add_index :trips, [:to_id, :from_id, :start_time]
  4. add_index :buses_services, :bus_id
  Итого:  (Views: 6845.8ms | ActiveRecord: 20.7ms)
  Дальше уже нет смысла оптимизировать, нужно фронтенд рисовать который это быстро показвать будет

## Резюме
  - Многоколоночные индексы конечно сильно все ускоряют, однако если на каждый запрос их ставить никакого места не напасешься
  - Потоковая загрузка не для прода однозначно, однако для засеивания базы вполне можно ее использовать
  - Жалко у меня не постгрес на работе