# Rails Optimization - HW3

## Подготовка

Для начала я запустил ```bundle install```, ```bin/setup```, сервер и проверил, что всё работает. Страница открывается, на странице расписание из 13 рейсов.

Я решил сразу написать тесты от регрессии:

1. Тест на импорт данных
2. Системный тест, который будет проверять страницу на наличие всех рейсов из ```example.json``` на странице и корректность их данных.

## A. Импорт данных

### Метрика

```example.json``` - 2.29 сек

```small.json``` - 10.07 сек

```medium.json``` - 76.6 сек

Большой файл запускать не рискнул :), но уже видно, что хоть ассимптотика и положительная, даже средний файл уже не укладывается в бюджет, поэтому нужно оптимизировать.

### Фидбек-луп

* Профилирование
* Точка роста
* Изменения, направленные на оптимизацию главной точки роста
* Метрика
* Повторное рофилирование - понять как повлияло на точку роста
* Коммит

### Точка роста №1

Сделал профилирование с помощью ```ruby-prof```, по отчёту больше всего времени занимают методы ```#find_or_create_by```, потом транзакции и т.д. Чтобы не создавать линшних запросов и транзакций, можно попробовать сначала записать все записи в память, а потом всё положить в базу с помощью ```#insert_all```.

Вынесу логику в ```lib/tasks/support``` в класс ```TripsReloader```.

Вроде бы получилось закодить, собираю в сеты объекты, самостоятельно выдаю ```id```, чтобы сразу указать связи и в конце запускаю ```insert_all!``` на все таблицы, проверяю.

```undefined method `insert_all!'``` - забыл обновить ```Rails``` :)

Теперь нужно создать модель для соединяющей таблицы ```buses_services```, чтобы удобнее было на ней использовать ```insert_all!```.



