# Case-study оптимизации

## Актуальная проблема
Ускорить загрузку страницы http://localhost:3000/автобусы/Самара/Москва
Ускорить загрузку данных через task rack

## Формирование метрики
Для того, чтобы понимать, дают ли мои изменения положительный эффект на быстродействие программы я стал использовать такую метрику:
 *тут ваша метрика*
 Benchmark.realtime
 rakc-mini-profiler
 
## Feedback-Loop
Для того, чтобы иметь возможность быстро проверять гипотезы я выстроил эффективный `feedback-loop`,
который позволил мне получать обратную связь по эффективности сделанных изменений за 
*время, которое у вас получилось*
* Примерно за 15 секунд на открытие страницы.
* Примерно за 20 секунд на загрузку small.json

Вот какие проблемы удалось найти и решить

### Ваша находка №1

    
- какой отчёт показал главную точку роста
    rack-mini-profiler показал
        Rendering: trips/index.html.erb	465.4	+38.8	101 sql	49.2
    Страница загружалась 1500.9 ms    
        
- как вы решили её оптимизировать
    Cократить кол-во запросов eager_load
- как изменилась метрика
    Страница загружалась 820.6 ms    medium.json

- как изменился отчёт профилировщика - исправленная проблема перестала быть главной точкой роста?
    Rendering: trips/index.html.erb	162.9	+9.1	2 sql	8.2

### Ваша находка №2
Увеличим файл до 30 000 строк. чтобы метрики были поточней и побольше.  Total: 2.741800
Загрузим large.json
Страница загружалась 15820.6 ms
- какой отчёт показал главную точку роста 
    Очень много подгрузок вьюх
- как вы решили её оптимизировать
    Отрисовывать всё в одном файле.
- как изменилась метрика
   Страница загружается за 277.1 ms
- как изменился отчёт профилировщика - исправленная проблема перестала быть главной точкой роста?
    Метрика улучшилась в разы.

### Ваша находка №3
Попробуем улучшить запрос 

- какой отчёт показал главную точку роста
Explain показал что у нас есть 
            ->  Seq Scan on buses_services  (cost=0.00..70.34 rows=4534 width=8) (actual time=0.017..0.571 rows=4534 loops=1)
            ->  Seq Scan on buses  (cost=0.00..18.00 rows=1000 width=23) (actual time=0.056..0.271 rows=1000 loops=1)
            ->  Seq Scan on services  (cost=0.00..1.10 rows=10 width=39) (actual time=0.005..0.007 rows=10 loops=1)                                  
            ->  Seq Scan on trips (cost=0.00..2,334.00 rows=970 width=34)


Planning time	:	1.960 ms
Execution time	:	48.898 ms

- как вы решили её оптимизировать
    при добавление индексов для таблицы trips
    один Seq Scan on trips пропадает.
    
    но остаются все остальные.
    Пробовал создавать как индексы по одной колонки во всех таблицах, так и по две колонки в одном индексе.
- как изменилась метрика
    скорость запроса
    в каждом из случаев плавает от 40мс до 80-90 мс.     
- как изменился отчёт профилировщика - исправленная проблема перестала быть главной точкой роста?
    нет, проблема не ушла.

### Ваша находка №3
- какой отчёт показал главную точку роста
    rack-mini-profiler
Есть возможность убрать еще один запрос, не использовать count
- как вы решили её оптимизировать
    заменил count trips.load.size
- как изменилась метрика
    скорость в принципе не изменилась. Но на один запрос стало меньше. А это значит уже есть профит.
- как изменился отчёт профилировщика - исправленная проблема перестала быть главной точкой роста?
    На один запрос к БД стало меньше.

## Результаты
В результате проделанной оптимизации наконец удалось обработать файл с данными.
Удалось улучшить метрику системы при импорте данных с НЕИЗВЕСТНОГО ВРЕМЕНИ, до мение 60 секунд на файл где 100_000 записей.
 + скорость загрузки страницы с 15 секунд  до (от 230мс). Сократив количество запросов и рендеринг страницы.
(
`fixtures/large.json` от 40 сек
`автобусы/Самара/Москва` от 230 мс.
)

## Защита от регрессии отображения
Для защиты от потери достигнутого прогресса при дальнейших изменениях программы *создал тест index.html.erb_spec.rb*

