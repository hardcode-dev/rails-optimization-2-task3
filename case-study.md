# Case-study оптимизации

## Актуальные проблемы

### Проблема №1
В нашем проекте возникла проблема. 

При увеличении объёма данных для импорта - слишком сильно увеличивается время работы скрипта 

Мы решили исправить эту проблему, оптимизировав данный скрипт

## Проблема №1: Формирование метрики
Для того, чтобы понимать, дают ли мои изменения положительный эффект на быстродействие программы я придумал использовать такую метрику: при помощи benchmark замерять сколько необходимо времени для успешного завершения программы. 
При помощи профилировщика RubyProf оценить объём аллоцируемой памяти. И при помощи valgrind-massif оценить кол-во потребляемой скриптом памяти программы.

## Проблема №1: Гарантия корректности работы оптимизированной программы
Для оценки работоспособности программы необхожимо написать тесты, чтобы в фидбек-лупе не позволять изменение логики программы при оптимизации.

## Проблема №1: Feedback-Loop
Для того, чтобы иметь возможность быстро проверять гипотезы я выстроил эффективный `feedback-loop`, который позволил мне получать обратную связь по эффективности сделанных изменений за 15 сек

Вот как я построил `feedback_loop`:
1. Замерил с помощью benchmark сколько времени нужно программе для завершения работы
2. Замерил с помощью Ruby-Prof кол-во аллоцируемой памяти
3. Замерил при помощи valgrind-massif сколько памяти использует скрипт во время всей работы
4. Проанализировал метрики
5. Нашел главную точку роста
6. Оптимизировал точку роста
7. Получилось увеличить скорость? -> Commit. Не получилось увеличить или получили обратный эффект -> Revert

### Проблема №1: Находка №1
- Какой отчёт показал главную точку роста
- Бенчмарк показал, что скрипт на маленьких данных отрабатывает очень долго (33 сек). Проверил что происходит внутри при помощи Ruby-Prof flat графика, он показал что больше всего времени уходит на PG::Connection#exec_prepared(20.82%)
- Как вы решили её оптимизировать
Видимо нужно попытаться минимизировать запросы к БД, попытаюсь сделать это с помощью кэша
- Как изменилась метрика
Скрипт начал работать ровно в два раза быстрее: примерно 16.4 сек
- Как изменился отчёт профилировщика - исправленная проблема перестала быть главной точкой роста?
Да, точка роста перестала быть главной

### Проблема №1: Находка №2
- Какой отчёт показал главную точку роста
- Скрипт всё ещё очень медленно работает, нас это не устраивает и мы решили оптимизировать его дальше. RubyProf показал новую точку роста PG::Connection#exec_params (31.3%)
- Как вы решили её оптимизировать
Это видимо уже готовит параметры ActiveRecord. Нужно как-то пропустить этот момент.
- Как изменилась метрика
Заменил Trip.create на Trip.insert, помогло немного, метрика изменилась на 5-6% (15 сек)
- Как изменился отчёт профилировщика - исправленная проблема перестала быть главной точкой роста?
Нет, точка роста осталась главной

### Проблема №1: Находка №3
- Какой отчёт показал главную точку роста
- Копаю дальше, PG::Connection#exec_params уже (36.4%), 
видимо в прошлой итерации оптимизировалось что-то не то:) 
- Как вы решили её оптимизировать
Это видимо уже готовит параметры ActiveRecord. Нужно как-то пропустить этот момент.
- Как изменилась метрика
Заменил Trip.create на Trip.insert, помогло немного, метрика изменилась на 5-6% (15 сек)
- Как изменился отчёт профилировщика - исправленная проблема перестала быть главной точкой роста?
Нет, точка роста осталась главной

### Проблема №1: Находка №4
- Какой отчёт показал главную точку роста
- Всё так-же как в прошлом шаге
- Как вы решили её оптимизировать
- Создал модель BusesService и добавил таблице buses_services уникальный индекст по полям bus_id, service_id. Чтобы загружать сервисы при помощи upsert_all.
- Как изменилась метрика
- Скрипт стал работать быстрее на 50%, теперь файл загружается за 7.8 сек
Заменил Trip.create на Trip.insert, помогло немного, метрика изменилась на 5-6% (15 сек)
- Как изменился отчёт профилировщика - исправленная проблема перестала быть главной точкой роста?
Нет, точка роста осталась главной, теперь PG::Connection#exec_params занимает 29.72% времени

### Проблема №1: Находка №5
- Какой отчёт показал главную точку роста
- Всё так-же как в прошлом шаге
- Как вы решили её оптимизировать
- Заменил метод insert на insert_all при создании записей Trip
- Как изменилась метрика
- Теперь файл загружается за 6.2 сек
- Как изменился отчёт профилировщика - исправленная проблема перестала быть главной точкой роста?
Нет, точка роста осталась главной, теперь PG::Connection#exec_params занимает 30.49% времени

## Проблема №1: Результаты
Начальная скорость работы скрипта: примерно 33 сек.

## Проблема №1: Защита от регрессии производительности
-
