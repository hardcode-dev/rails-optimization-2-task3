# Rails Optimization - HW3

## Подготовка

Для начала я запустил ```bundle install```, ```bin/setup```, сервер и проверил, что всё работает. Страница открывается, на странице расписание из 13 рейсов.

Я решил сразу написать тесты от регрессии:

1. Тест на импорт данных
2. Системный тест, который будет проверять страницу на наличие всех рейсов из ```example.json``` на странице и корректность их данных.

## A. Импорт данных

### Метрика

```example.json``` - 2.29 сек

```small.json``` - 10.07 сек

```medium.json``` - 76.6 сек

Большой файл запускать не рискнул :), но уже видно, что хоть ассимптотика и положительная, даже средний файл уже не укладывается в бюджет, поэтому нужно оптимизировать.

### Фидбек-луп

* Профилирование
* Точка роста
* Изменения, направленные на оптимизацию главной точки роста
* Метрика
* Повторное рофилирование - понять как повлияло на точку роста
* Коммит

### Точка роста №1

Сделал профилирование с помощью ```ruby-prof```, по отчёту больше всего времени занимают методы ```#find_or_create_by```, потом транзакции и т.д. Чтобы не создавать линшних запросов и транзакций, можно попробовать сначала записать все записи в память, а потом всё положить в базу с помощью ```#insert_all```.

Вынесу логику в ```lib/tasks/support``` в класс ```TripsReloader```.

Вроде бы получилось закодить, собираю в сеты объекты, самостоятельно выдаю ```id```, чтобы сразу указать связи и в конце запускаю ```insert_all!``` на все таблицы, проверяю.

```undefined method `insert_all!'``` - забыл обновить ```Rails``` :)

Теперь нужно создать модель для соединяющей таблицы ```buses_services```, чтобы удобнее было на ней использовать ```insert_all!```.

Несколько итераций исправлений ошибок и тесты начали проходить успешно, а большой файл импортировался за 14.85 секунд.

Закрепим результат performance тестом, меньше 0.4 секунды для ```small.json```.

## Б. Отображение расписаний

### Метрика

После загрузки всех рейсов (```large.json```) ```rack-mini-profiler``` показал, что страница загружается за ~27 секунд, попробуем поставить бюджет примерно в 1 секунду.

### Точка роста №1

Попробовал ```rack-mini-profiler``` и ```PgHero```, самое основное, что бросается в глаза - 600+ запросов сервисов. Скорее всего есть N+1.

Добавил ```.preload(bus: :services)```, теперь страница загрузилась за 15 секунд, а запросов осталось всего 8.

### Точка роста №2

Следующая точка роста - запрос ```trips``` по ```from_id``` и ```to_id```. Попробую сделать ```EXPLAIN``` через ```PgHero```. Вижу, что запрос идёт ```Seq Scan```'ом по всей таблице, значит нужно добавить индекс.

### Точка роста №3

Время работы сильно не ускорилось, а всё потому, что как показал ```rails_panel``` большую часть времени занимают не запросы к БД, а рендеринг (да, в логе сервера это тоже можно было легко увидеть).

Немного почитав про паршиалы, решил попробовать использовать опцию ```collection``` при рендере, чтобы паршиал не загружался каждый раз из файла.

Проще оказалось даже использовать shortcut ```render @trips```, но сильных улучшений это не дало из-за того, что внутри паршиала всё ещё рендерятся другие паршиалы, поэтому все остальные паршиалы я перенёс в ```_trip.html.erb```. После этого страница стала загружаться за 400-500мс.

Нужно закрепить результат performance тестом,
