# Оптимизация импорта данных

## Задача

Нужно оптимизировать механизм перезагрузки расписания из файла так, чтобы он импортировал файл `large.json` в пределах
минуты.

## Рабочий процесс

Для начала я решил узнать за какое время выполняется импорт данных в текущей реализации.
Получилось что импорт файла `medium.json` выполняется 58 секунд.
Соответственно импорт файла `large.json` будет выполняться сильно дольше и мы не уложимся в бюджет, следовательно
необходимо оптимизировать этот процесс.

Перед внесением изменений я решил покрыть имеющийся функционал тестами чтобы ничего не сломать (см
test/integration/bus_schedule_test.rb).

Далее, после изучения отчетов профилировщиков стало понятно что основное время тратится на методах относящихся к
соединению с БД.
Следовательно можно уменьшить время выполнения программы сократив количесво транзакций с БД, с чем может помочь
гем `activerecord-import`.

После переписывания программы с использованием гема импорт файла `medium.json` занимает менее 4 секунд:

```bash
# bin/rake reload_json[fixtures/medium.json]
Finish in 3.53
```

а импорт файла `large.json` менее 30 секунд:

```bash
# bin/rake reload_json[fixtures/large.json]
Finish in 28.93
```

Метрика укладывается в бюджет, задача выполнена.

# Оптимизация отображения расписаний

## Задача

Нужно найти и устранить проблемы, замедляющие формирование этих страниц (какое время рендеринга страницы считать
удовлетворительным???).

## Рабочий процесс

Из логов можно увидеть что основное время тратится на рендеринг вьюх:

```
Completed 200 OK in 457ms (Views: 367.1ms | ActiveRecord: 84.5ms)
```

это время можно сократить избавившись от паршалов. После переработки имеем:

```
Completed 200 OK in 197ms (Views: 130.7ms | ActiveRecord: 63.8ms)
```

Так же в логах наглядно видна N+1 проблема при получении автобуса и его сервисов.
После её исправления имеем:

```
Completed 200 OK in 63ms (Views: 50.5ms | ActiveRecord: 9.5ms)
```

`rack-mini-profiler` показывает что наибоьшее время тратится на запрос трипов (выполняется Seq Scan),
ускорить этот запрос можно добавлением индексов на поля `from_id` и `to_id`.
После чего выполнение запроса сократилось с 30 мс до 11 мс.

После загрузки файла `large.json` время рендеринга страницы `автобусы/Самара/Москва`:

```
Completed 200 OK in 204ms (Views: 69.6ms | ActiveRecord: 9.1ms)
```