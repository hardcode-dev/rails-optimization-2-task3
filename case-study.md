# Case-study оптимизации

## Актуальная проблема

Требуется обработать файл `large.json`. Время его обработки велико.

## Формирование метрики

- small.json (1K трипов)
- medium.json (10K трипов)
- large.json (100K трипов)

время полной обработки `large.json` должно составлять не более 60сек.

## Гарантия корректности работы оптимизированной программы

Программа поставлялась без теста. Для того чтобы гарантировать неизменность загружаемость в БД и данных на выходе из контроллера: был добавлен альтернативный метод в контролллере и написан тест `test_spec.rb`

## Feedback-Loop

Для того, чтобы иметь возможность быстро проверять гипотезы я выстроил эффективный `feedback-loop`, который позволил мне получать обратную связь по эффективности сделанных изменений за *разумное время*. 
Вот как я его построил

#### Для первой части задания:

- запускается профилировщик: `test_profile_spec.rb`
- происходит анализ полученных данных и внесение изменений в файл загрузки данных: `utils.rake`
- тестируем валидность обрабатываемой информации: `test_spec.rb`
- тестирование скорости загрузки: `test_performance_spec.rb` 2 разогревочных, 5 измерительных тестов

быстрая проверка валидности кода: `rspec spec/test_spec.rb`

## Вникаем в детали системы, чтобы найти главные точки роста
Для того, чтобы найти "точки роста" для оптимизации я воспользовался 
- rspec-benchmark
- ruby-prof

## Вот какие проблемы удалось найти и решить

#### Находка №1
- т.к. это первый запуск, нужно произвести замер производительности: 9.12 сек для файла small.json
- проведен рефакторинг
- время загрузки большого файла: 31.9 сек
- `rspec spec/test_performance_spec.rb`

#### Находка №2
- с помошью 'rack-mini-profiler' был обнаружен N+1
- добавлен includes(*[bus: [:services]]) 
- количество запросов в базу было 30, стало 7
- время уменьшилось примерно на 100% было около 200мс, стало около 100мс

#### Находка №3
- с помошью консоли сервера было обнаружено, что очень много времени уходит на рендеринг шшаблонов
- убрал все шаблоны и перенес их в один: время рендеринга уменьшилось в !4! раза до 25мс


## Результаты
* первая задача решена заменой алгоритма
* вторая задача это rack-mini-profiler + консоль

время исполнения локально удалось уменьшить в 8 раз для ограниченного набора данных.
т.к. при увеличении количества данных в старом варианте время продолжило бы рости линейно, а в текущем оно фактически остановлено, считаю работу успешной 

