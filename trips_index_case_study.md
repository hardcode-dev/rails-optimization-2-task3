# Оптимизация страницы расписания

### Подготовка:

- подгрузил `small.json` в базу
- нашел самое популярное направление Сочи-Рыбинск (17 рейсов)
- установил bullet, rails panel, rack mini profiler
- установил capybara и написал системный тест на отображение трипов на странице, чтобы ничего не сломать во время оптимизации
- замерил загрузку страницы, она составила в среднем 360ms

В качестве метрики выбрал скорость загрузки страницы, замеряю ее с помощью rails panel.

В качестве бюджета принял, чтобы страница загружалась не более чем 90ms

Решил для начала оптимизировать запросы к базе, их было больше чем количество трипов на странице.

---
#### Находка 1

В rails panel заметил что внутри паршилов есть долгие запросы к buses (14-17ms)

bullet также показал, что есть N + 1 к buses.

Сделал оптимизацию, подгрузил bus в контроллере.

Метрика уменьшилась до 296ms

Долгие запросы к buses перестали быть главной точкой роста

---

#### Находка 2

Новая точка роста - это запросы к services.

bullet снова подсказывает что можно подгрузить bus_services и services

Сделал оптимизацию, подгрузив все нужное в контроллере.

Метрика уменьшилась до 193ms

---

#### Находка 3

Новая точка роста это запрос к bus_services.

Проанализировал запрос с помощью explain и увидел что там seq scan 

Добавил индекс, запрос стал вдвое быстрее отрабатывать

Проверил explain, теперь используется созданный индекс

Метрика уменьшилась до 137ms


#### Находка 4

Долгих запросов в базу теперь нет, количество запросов на всю страницу сократилось.

Теперь перехожу к оптимизации рендеринга, рендеринг занимает большую часть времени.

Убрал delimiter из отдельного файла, так как отдельный файл отрендерить сложнее чем просто строку, файл надо подгрузить, скомпилировать и отрендерить для каждого трипа.

Тоже самое сделал для service.

Метрика уменьшилась до 118ms

#### Находка 5

Основная точка роста все еще рендеринг index

Добавил кеширование коллекции trips и services

Метрика уменьшилась до 80ms после прогрева кеша, что укалыдвается в наш бюджет.



