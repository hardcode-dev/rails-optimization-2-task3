#### Решение задачи №3

#### Первая часть
Обозначим проблему - очень долгая загрузка файла data_large.json
Обозначим основную метрику и бюджет: основная метрика - время загрузки файла, оптимальный бюджет - 1 минута для data_large
#### Выстроим feeedback loop
 Для начала обойдемся банальным rspec-benchmark для банального замера времени
Для более удобной работы вынесим из рейк таски основные действия в отдельный сервис класс (удобно и понятно тестировать)
Включим pgbadger для построения отчетов

#### Оптимизация по Feeback loop
1. При помощи отчета pgbadger и простенького теста обнаружил что даже средний файл уже не помешается в бюджет, а конкретно отчет показал что у нас проблема даже не с записью в БД а из за того что из нее постоянно что то селектят. 1,6k селектов на 55 инсертов при маленьком файле

2. Среднее число записей уже не укладывается в бюджет, отчет pgbadger показывает уверенные точки роста (больше селектов чем инсертов) а так же указывает на самый медленный запрос (10 секунд для запроса который выбирает сервисы по id автобуса)
Начнем рефакторинг и переезд на acitverecord_import. Для этого сначала напишем простенький тест для проверки что ничего не сломали, а потом уже начнем переделывать экспорт.
Результат - после выноса в словари средний файл начал укладываться в бюджет. Показатели селектов сильно не упали

3. Продолжаем ориентироваться на спеку и отчет bgbadger - снижаем количество селектов. Продолжаем рефакторинг блока.
Полностью ушел в activerecord_import и влез в бюджет 30 секунд для large.json. Отчет уже явно не указывает на частые селекты. Можно копать дальше но перехожу ко второму заданию - время не позволяет

4. Перешел на вторую часть и оказалось что кто то врет. Если не запускать в тесте - то large показыввает на 2 минуты 40 секунд. rspec benchmark по времени не отрабатывает тесты. Пробую построить более достоверный тест. Так же обнаружил дырку в своей логике - создавал отдельный сервис на каждый автобус (при этом сервисов всего 10 штук а я вообще не создвал связь между автобусом и списком сервисов)
Решил для начала вынести сервисы в константу и добавить индексы.
По результатам - уже точно вошел в бюджет, 27 секунд. На порядки упали инсерты и селекты. Ушел от ненужных связей, сделал более явные индесы и связи между таблицами. Открыл для себя detect. А так же положил к черту запись в лог постгры и 2 часа чинил. Так же database_cleaner c benchmark_rspec работает очень криво. Потерял много времени пока это выяснял.

#### Вторая часть
Обозначим проблему - очень долгая загрузка страницы и неоптимальные выборки. Много лишнего и странного
Обозначим основную метрику и бюджет: основная метрика - время загрузки страницы отталкиваемся от 8557 мс.

#### Выстроим feeedback loop
 Rails panel и Mini profiler довольно удобно показывают как количество запросов на странице так и время ее загрузки. На основе их и будем строить цикл.

#### Оптимизация по Feeback loop
На странице очень много запросов, начнем с их оптимизации.
Убрал все N+1 запросы, попробовал несколько вариантов. Время оптимизировалось в лучшем случае до 2,5 секунд но в среднем и чаще - 3,5 секунды. Добавил простой кеш, перешел на партици и рендер коллекций. В самый ответсвенный момент перестал работать rails panel поэтому иду по приборам. Пока что судя по логам основное время занимает рендер. Так же добавил дополнительный индекс.


